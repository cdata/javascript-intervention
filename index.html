<!doctype html>  
<html lang="en">
	
	<head>
		<meta charset="utf-8">
		
		<title>reveal.js</title>

		<meta name="description" content="An easy to use CSS 3D slideshow tool for quickly creating good looking HTML presentations.">
		<meta name="author" content="Hakim El Hattab">
		
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
		
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/main.css">

		<link rel="stylesheet" href="lib/zenburn.css">
	</head>
	
	<body>
		
		<div id="reveal">
			
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>JavaScript @ CloudFlare</h1>
					<h3 class="inverted">an intervention</h3>
				</section>
                <section>
                    <h2>Hi I'm Chris</h2>
                    <p>Some projects I work on at CloudFlare:</p>
                    <ul>
                        <li>Rocket Loader</li>
                        <li>CloudFlareJS</li>
                        <li>Image Optimization, Resource Preloading, Tracking..</li>
                    </ul>
                    <p style="margin-top: 20px;"><a href="mailto:chris@cloudflare.com">chris@cloudflare.com</a>&nbsp;&middot;&nbsp;<a href="http://twitter.com/robodynamo">@robodynamo</a></p>
                </section>
                <section>
                    <section>
                        <h2>First, a cheap meme:</h2>
                        <img src="assets/images/thegoodparts.jpg" />
                    </section>
                    <section>
                        <h2>Another perspective:</h2>
                        <img src="assets/images/thegoodparts2.jpg" />
                    </section>
                    <section>
                        <h2>And again:</h2>
                        <img src="assets/images/thegoodparts3.jpg" />
                    </section>
                    <section>
                        <h2>Seriously?</h2>
                        <img src="assets/images/evilparts.png" height="380" />
                    </section>
                </section>
                <section>
                    <h2>Beards</h2>
                    <img src="assets/images/beards.png" height="300" />
                    <p><span>John McCarthy (Lisp), </span><span>Dennis Ritchie (C), </span><span>Bjarne Stroustrip (C++), </span><span>James Gosling (Java), </span><span>Guido van Rossum (Python), </span><span>Brendan Eich (JavaScript)</span></p>
                </section>
                <section>
                    <h2>JavaScript is..</h2>
                    <ul>
                        <li class="fragment">..not a great language</li>
                        <li class="fragment">..not going away soon</li>
                        <li class="fragment">..something we're tyring to improve at CloudFlare</li>
                    </ul>
                </section>
                <section>
                    <h2>Meet the lowly identifier</h2>
                    <pre><code>foo</code></pre>
                    <pre class="fragment"><code>
> foo
Reference Error: foo is not defined
                    </code></pre>
                    <pre class="fragment"><code>
> var foo
undefined
                    </code></pre>
                    <pre class="fragment"><code>
> foo

  [0, 1, 2, 3, 4, 5].forEach(
    function() {

      // Do stuff..
    }
  );
  
  var foo
undefined
                    </code></pre>
                </section>
                <section>
                    <section>
                        <h2>Truthiness and Falsiness</h2>
                        <pre><code>
// Falsey values:
// false, 0, undefined, null, NaN, ''

var foo = '';

if(foo)
    console.log("This sentence is never spoken.");

// Truthy values:
// Anything that is not a falsey value

var bar = 100;

if(bar)
    console.log("Bar is truthy, so consider this logged.");
                        </code></pre>
                    </section>
                    <section>
                        <h2>Falsey or not</h2>
                        <pre><code>
> NaN == undefined
false

> null == undefined
false

> undefined == null
true
                        </code></pre>
                    </section>
                    <section>
                        <h2>What to do?</h2>
                        <h3 class="fragment">Use === instead of ==</h3>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Clever type coercion</h2>
                        <p>Evidence of cleverness in JavaScript: the + operator</p>
                        <ul>
                            <li>Adds numbers.. AND concatenates strings</li>
                            <li>Not a number? Not a string? Converted automatically.</li>
                            <li>Chaos ensues</li>
                        </ul>
                        <p><a href="http://jsconsole.com/">Demo time</a></p>
                    </section>
                    <section>
                        <h2>Basic arithmentic</h2>
                        <pre><code>
> 1 + 1
2

> 1 + " + " + 1
"1 + 1"

> "1 + 1 = " + 1 + 1
"1 + 1 = 11"
                        </pre></code>
                    </section>
                    <section>
                        <h2>Advanced maths</h2>
                        <pre><code>
> [] + []
""

> [] + {}
"[object Object]"

> {} + {}
NaN
                        </pre></code>
                        <p class="fragment">(wat)</p>
                    </section>
                </section>
                <section>
                    <h1>Why do we use JavaScript?</h1>
                </section>
                <section>
                    <h2>Some topical quotes</h2>
                    <p>"JavaScript won because it's the best terrible language ever made."</p>
                    <p>"Javascript is the worst language ever to be deployed on every major browser in the world"</p>
                </section>
                <section>
                    <h1>JavaScript is in your browser</h1>
                </section>
                <section>
                    <h2>Everything is built with JavaScript</h2>
                    <ul>
                        <li>Photo galleries</li>
                        <li>Facebook feeds &amp; Twitter timelines</li>
                        <li>Likes, Plus Ones, Nyancats</li>
                    </ul>
                </section>
                <section>
                    <h2>JavaScript is slow</h2>
                    <ul>
                        <li>JavaScript does not run as fast as native code</li>
                        <li>
                            <img src="assets/images/turtle.png" height="300"/>
                        </li>
                        <li>JavaScript downloading "blocks" other website resources</li>
                        <li>JavaScript EXECUTION "blocks" other website resources</li>
                    </ul>
                </section>
                <section>
                    <h2>Complicating things</h2>
                    <p>JavaScript can be used to load more JavaScript!</p>
                    <img src="assets/images/inception.jpg" />
                </section>
                <section>
                    <section>
                        <h2>What is this "blocks" thing?</h2>
                        <p>When JavaScript downloads and runs, it prevents other parts of the page (including other JavaScript) from downloading and running.</p>
                    </section>
                    <section>
                        <h2>A contrived HTML document</h2>
                        <pre><code>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;

        &lt;title&gt;Awesome Webpage&lt;/title&gt;

        &lt;script type="text/javascript" src="/some/javascript.js"&gt;&lt;/script&gt;

        &lt;link rel="stylesheet" href="/some/stylesheet.css" /&gt;

    &lt;/head&gt;
    &lt;body&gt;

        &lt;h1&gt;Awesome webpage header!&lt;/h1&gt;

    &lt;/body&gt;
&lt;/html&gt;
                        </code></pre>
                    </section>
                    <section>
                        <h2>The impact of blocking</h2>
                        <img src="assets/images/blocking.png" />
                    </section>
                </section>
                <section>
                    <h1>Enter The Rocket</h1>
                    <p>We built Rocket Loader to make JavaScript not 'block'</p>
                </section>
                <section>
                    <h2>"The plan"</h2>
                    <h3>by Steve Souders</h3>
                    <ol>
                        <li class="fragment">Break all script tags to stop them from loading</li>
                        <li class="fragment">While the page loads, preload scripts asynchronously</li>
                        <li class="fragment">???</li>
                        <li class="fragment">Allow the page to load completely</li>
                        <li class="fragment">Step through all broken scripts and "fix" them so that they execute</li>
                        <li class="fragment">Profit</li>
                    </ol>
                </section>
                <section>
                    <h2>This is really hard</h2>
                    <ul>
                        <li>How do you break scripts before they start downloading?</li>
                        <li>How do you preload scripts without executing them?</li>
                        <li>document.write</li>
                    </ul>
                </section>
                <section>
                    <h2>A word on document.write</h2>
                    <h1 class="fragment">DONT</h1>
                </section>
                <section>
                    <h2>CloudFlare domination strategy</h2>
                    <ol>
                        <li>NGINX "breaks" all scripts</li>
                        <li>PHP backend gives us same-domain AJAX ("the bag")</li>
                        <li>JavaScript client library ("Rocket") handles execution</li>
                    </ol>
                </section>
                <section>
                    <h2>How do you "break" scripts?</h2>
                    <p>Before:</p>
                    <pre><code>
&lt;script type="text/javascript" src="/javascripts/jquery.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/javascripts/cornify.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
    $(function() {

        alert('am i doin it rigjt?');
    });
&lt;/script&gt;
                    </pre></code>
                    <div class="fragment">
                        <p>After:</p>
                        <pre><code>
&lt;script type="text/rocketscript" data-rocketsrc="/javascripts/jquery.js"&gt;&lt;/script&gt;
&lt;script type="text/rocketscript" data-rocketsrc="/javascripts/cornify.js"&gt;&lt;/script&gt;
&lt;script type="text/rocketscript"&gt;
    $(function() {

        alert('am i doin it rigjt?');
    });
&lt;/script&gt;
                        </pre></code>
                    </div>
                </section>
                <section>
                    <section>
                        <h2>CloudFlare's (sexy) bag</h2>
                        <p>Also known as the JavaScript proxy.</p>
                    </section>
                    <section>
                        <h2>Preload JavaScript via AJAX</h2>
                        <p>CloudFlare sets up a same-domain AJAX endpoint</p>
                        <pre><code>
http://www.example.com/
                        </code></pre>
                        <p>has "the bag" at</p>
                        <pre><code>
http://www.example.com/cdn-cgi/pe/bag
                        </code></pre>
                    </section>
                    <section>
                        <h2>We can ask "the bag" for JavaScript</h2>
                        <pre><code>
GET /cdn-cgi/pe/bag?r[]=/javascripts/some.js&amp;r[]=/javascripts/another.js&amp;r[]=/javascripts/final.js
                        </code></pre>
                        <p>In other words, "give me the following scripts:"</p>
                        <ul>
                            <li>/javascripts/some.js</li>
                            <li>/javascripts/another.js</li>
                            <li>/javascripts/final.js</li>
                        </ul>
                    </section>
                    <section>
                        <h2>"The bag" sends JS back as text</h2>
                        <pre><code>
--foobar
Bag: 257|222|-1|200|text/bag-manifest

0:http://www.example.com/javascripts/some.js
1:http://www.example.com/javascripts/another.js
2:http://www.example.com/javascripts/final.js

--foobar
Bag: 79|39|0|200|application/x-javascript|7200

function small1(bleh) {
    return bleh;
}

--foobar
Bag: 79|39|2|200|application/x-javascript|7200

function small2(bleh) {
    return bleh;
}

--foobar
Bag: 79|39|1|200|application/x-javascript|7200

function small3(bleh) {
    return bleh;
}

--foobar--
                        </code></pre>
                    </section>
                    <section>
                        <h1>A big advantage</h1>
                        <p>All your JavaScript is loaded in one request</p>
                        <p>Text can be stored in localStorage and executed in a controlled way</p>
                    </section>
                    <section>
                        <h1>Stylesheets</h1>
                        <h2>coming to a bag near you</h2>
                    </section>
                </section>
                <section>
                    <h1>Finally</h1>
                    <h3>The page is loaded</h3>
                    <h3>The JavaScript is precached</h3>
                    <h3>Time to rocket</h3>
                </section>
                <section>
                    <h2>Rocket Loader executes scripts</h2>
                    <p>Page order must be maintained</h2>
                    <p>All page events are simulated</p>
                    <p>Page state is masked</p>
                </section>
                <section>
                    <h2>Scripts are difficult to manage</h2>
                    <p>They look at themselves (introspection)</p>
                    <p>They insert other scripts</p>
                    <p>They call document.write</p>
                </section>
                <section>
                    <section>
                        <h2>Handling curious scripts</h2>
                        <p>Trick them into thinking the world is different.</p>
                    </section>
                    <section>
                        <h2>Page events</h2>
                        <p>Simplified example:</p>
                        <pre><code>
window.addEventListener = function(type) {

    if(type == 'load')
        deferHandler(arguments);
    else
        listenNormally.apply(window, arguments);

}
                        </code></pre>
                    </section>
                    <section>
                        <h2>Introspection</h2>
                        <p>Simplified example:</p>
                        <pre><code>
document.getElementsByTagName = function(type) {

    if(type == 'script')
        return listOfFakeScripts;
    else
        return normalListOfElements;

}
                        </code></pre>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>More on document.write</h2>
                        <ul>
                            <li>Intended for insertion while HTML is parsing</li>
                            <li>If it happens late, it kills the page</li>
                            <li>It happens EVERYWHERE (ads)</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Rocket overrides document.write</h2>
                        <p>Simplified example:</p>
                        <pre><code>
document.write = function(out) {

    console.log("Appending to document.write buffer: \n" + out);

    parser.parseChunk(out);
};
                        </code></pre>
                    </section>
                    <section>
                        <h2>Rocket has a parser</h2>
                        <ul>
                            <li>Raw HTML is passed to parser</li>
                            <li>Parser generates an abstract representation</li>
                            <li>AST is sent back to vile script from whence it came</li>
                        </ul>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>When scripts have babies</h2>
                        <p>Dynamically created scripts are 'bagged' on the fly.</p>
                    </section>
                    <section>
                        <h2>With document.write</h2>
                        <p>Scripts created with document.write are added to the queue after their parent.</p>
                    </section>
                    <section>
                        <h2>With document.createElement</h2>
                        <p>Scripts created with document.create element are added to the end of the queue.</p>
                    </section>
                </section>
                <section>
                    <h2>The final result</h2>
                    <iframe src="http://player.vimeo.com/video/24293160?title=0&amp;byline=0&amp;portrait=0" width="400" height="168" frameborder="0"></iframe>
                </section>
                <section>
                    <section>
                        <h2>A short bit on CFJS</h2>
                        <ul>
                            <li class="fragment">Born from Rocket Loader</li>
                            <li class="fragment">Open source &amp; backwards compatible to IE6</li>
                            <li class="fragment">Platform for loading / sandboxing JS apps the right way</li>
                            <li class="fragment">Works with or without the bag</li>
                            <li class="fragment">We use it for apps and all internal JS projects</li>
                            <li class="fragment">Learn more about <a href="http://js.cloudflare.com/">CloudFlareJS</a></li>
                            <li class="fragment">Learn more about <a href="http://www.commonjs.org/">CommonJS</a></li>
                        </ul>
                    </section>
                    <section>
                        <h2>A quick demo</h2>
                        <pre><code>
// Insert CFJS
try{window.CloudFlare||function(){var a=window.document,b=a.createElement("script"),a=a.getElementsByTagName("script")[0];window.CloudFlare=[];b.type="text/javascript";b.async=!0;b.src="//ajax.cloudflare.com/cdn-cgi/nexp/cloudflare.js";a.parentNode.insertBefore(b,a)}()}catch(e$$5){try{console.error(e$$5.message)}catch(e$$6){}};

// Load important code
CloudFlare.require(['http://www.cornify.com/js/cornify.js'], function() { for(var i = 0; i &lt; 50; i++) cornify_add(); });
                        </code></pre>
                        <p><a href="http://www.newscorp.com/">Demo site</a></p>
                    </section>
                </section>
                <section>
                    <h2>Looking forward</h2>
                    <ul>
                        <li>Mirage: automatically optimizing images</li>
                        <li>CSS loading through Rocket Loader</li>
                        <li>CloudFlare Apps</li>
                        <li>CFJS and Advertising... and YOU</li>
                    </ul>
                </section>
                <section>
                    <h1>Fin</h1>
                </section>
            </div>
			<!-- The navigational controls UI -->
			<aside class="controls">
				<a class="left" href="#">&#x25C4;</a>
				<a class="right" href="#">&#x25BA;</a>
				<a class="up" href="#">&#x25B2;</a>
				<a class="down" href="#">&#x25BC;</a>
			</aside>

			<!-- Displays presentation progress, max value changes via JS to reflect # of slides -->
			<div class="progress"><span></span></div>
			
		</div>
		
		<script src="js/reveal.js"></script>
		<script src="lib/highlight.js"></script>
		<script>
			// Parse the query string into a key/value object
			var query = {};
			location.search.replace( /[A-Z0-9]+?=(\w*)/gi, function(a) {
				query[ a.split( '=' ).shift() ] = a.split( '=' ).pop();
			} );

			Reveal.initialize({
				// Display controls in the bottom right corner
				controls: true,

				// Display a presentation progress bar
				progress: true,

				// If true; each slide will be pushed to the browser history
				history: true,

				// Flags if mouse wheel navigation should be enabled
				mouseWheel: true,

				// Apply a 3D roll to links on hover
				rollingLinks: true,

				// UI style
				theme: query.theme || 'default', // default/neon

				// Transition style
				transition: query.transition || 'default' // default/cube/page/concave/linear(2d)
			});

			hljs.initHighlightingOnLoad();
		</script>

	</body>
</html>
